name: Build and Deploy to Android

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Linux runner inside WSL

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Set JAVA_HOME
      - name: Set JAVA_HOME
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          java -version
        shell: bash

      # 3ï¸âƒ£ Build Spring Boot JAR
      - name: Build Spring Boot
        run: |
          dos2unix ./gradlew
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test
        shell: bash

      # 4ï¸âƒ£ Debug build output
      - name: Debug build/libs
        run: |
          echo "=== build/libs ==="
          ls -l "$GITHUB_WORKSPACE/build/libs"
        shell: bash

      # 5ï¸âƒ£ Write SSH key to runner temp
      - name: Write SSH key
        run: |
          KEY_PATH="$HOME/android_key.pem"

          # Decode base64 private key from secret
          echo "$ANDROID_KEY_BASE64" | base64 --decode > "$KEY_PATH"

          # Fix permissions
          chmod 600 "$KEY_PATH"

          echo "âœ… SSH key written to $KEY_PATH"

          # Optional: debug first 5 lines of key
          echo "=== FIRST 5 LINES OF KEY ==="
          head -n 5 "$KEY_PATH"
        shell: bash
        env:
          ANDROID_KEY_BASE64: ${{ secrets.ANDROID_KEY_BASE64 }}

      # 6ï¸âƒ£ Copy & Run JAR on Android
      - name: Copy & Run JAR on Android
        run: |
          set -euo pipefail
          set -x  # Debug output

          # Paths
          KEY_PATH="$HOME/android_key.pem"
          JAR_PATH=$(find "$GITHUB_WORKSPACE/build/libs" -name "*.jar" | head -n 1)

          if [ -z "$JAR_PATH" ]; then
            echo "âŒ No JAR found in build/libs"
            exit 1
          fi

          echo "KEY_PATH = $KEY_PATH"
          echo "JAR_PATH = $JAR_PATH"
          echo "ANDROID_USER = $ANDROID_USER"
          echo "ANDROID_HOST = $ANDROID_HOST"
          echo "ANDROID_PORT = $ANDROID_PORT"

          # --- Test SSH connection ---
          ssh -i "$KEY_PATH" -p "$ANDROID_PORT" -o StrictHostKeyChecking=no "$ANDROID_USER@$ANDROID_HOST" "echo SSH connected"

          # --- Copy JAR to Termux home directory (safer) ---
          echo "ðŸš€ Copying JAR to Android..."
          scp -v -i "$KEY_PATH" -P "$ANDROID_PORT" "$JAR_PATH" "$ANDROID_USER@$ANDROID_HOST:~/app.jar"

          # --- Kill any running instance safely ---
          echo "ðŸš€ Stopping any existing app.jar process..."
          ssh -i "$KEY_PATH" -p "$ANDROID_PORT" "$ANDROID_USER@$ANDROID_HOST" \
          "ps -ef | grep '[j]ava.*app.jar' | awk '{print \$2}' | xargs -r kill -9 || true"

          # --- Move JAR to final location if needed ---
          ssh -i "$KEY_PATH" -p "$ANDROID_PORT" "$ANDROID_USER@$ANDROID_HOST" "mv ~/app.jar /data/data/com.termux/files/home/app.jar || true"

          # --- Start app in background ---
          echo "ðŸš€ Starting app.jar on Android..."
          ssh -i "$KEY_PATH" -p "$ANDROID_PORT" "$ANDROID_USER@$ANDROID_HOST" \
          "nohup /data/data/com.termux/files/usr/bin/java -jar /data/data/com.termux/files/home/app.jar > app.log 2>&1 &"

          echo "âœ… App started in background on Android"
        shell: bash
        env:
          ANDROID_KEY_BASE64: ${{ secrets.ANDROID_KEY_BASE64 }}
          ANDROID_USER: ${{ secrets.ANDROID_USER }}
          ANDROID_HOST: ${{ secrets.ANDROID_HOST }}
          ANDROID_PORT: ${{ secrets.ANDROID_PORT }}
          GITHUB_WORKSPACE: ${{ github.workspace }}

