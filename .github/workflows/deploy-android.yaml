name: Build and Deploy to Android

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Linux runner inside WSL

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Set JAVA_HOME
      - name: Set JAVA_HOME
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          java -version
        shell: bash


      # 3ï¸âƒ£ Build Spring Boot JAR
      - name: Build Spring Boot
        run: |
          dos2unix ./gradlew
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test
        shell: bash


      # 4ï¸âƒ£ Write SSH key
      - name: Write SSH key
        run: |
          KEY_PATH="$RUNNER_TEMP/android_key.pem"
          echo "$ANDROID_KEY_BASE64" | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "âœ… SSH key written to $KEY_PATH"
        shell: bash
        env:
          ANDROID_KEY_BASE64: ${{ secrets.ANDROID_KEY_BASE64 }}

      # 5ï¸âƒ£ Copy & Run JAR on Android
      - name: Copy & Run JAR on Android
        run: |
          KEY_PATH="$RUNNER_TEMP/android_key.pem"

          # Find the JAR
          JAR_PATH=$(find "$GITHUB_WORKSPACE/build/libs" -name "*.jar" | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "âŒ No JAR found in build/libs"
            exit 1
          fi

          # Copy JAR to Android via SCP
          echo "ðŸš€ Copying JAR to Android..."
          scp -i "$KEY_PATH" -P $ANDROID_PORT "$JAR_PATH" "$ANDROID_USER@$ANDROID_HOST:/data/data/com.termux/files/home/app.jar"

          # Run JAR on Android
          echo "ðŸš€ Starting app.jar on Android..."
          ssh -i "$KEY_PATH" -p $ANDROID_PORT "$ANDROID_USER@$ANDROID_HOST" \
            "pkill -f app.jar || true; nohup java -jar /data/data/com.termux/files/home/app.jar > app.log 2>&1 &"

          echo "âœ… App started in background on Android"
        shell: bash
        env:
          ANDROID_KEY_BASE64: ${{ secrets.ANDROID_KEY_BASE64 }}
          ANDROID_USER: ${{ secrets.ANDROID_USER }}
          ANDROID_HOST: ${{ secrets.ANDROID_HOST }}
          ANDROID_PORT: ${{ secrets.ANDROID_PORT }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
