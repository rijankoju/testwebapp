name: Build and Deploy to Android

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Windows self-hosted runner

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set JAVA_HOME
      - name: Set JAVA_HOME for this job
        shell: cmd
        run: |
          echo Setting JAVA_HOME
          set "JAVA_HOME=C:\Program Files\Java\jdk-24"
          set "PATH=%JAVA_HOME%\bin;%PATH%"
          java -version

      # 3Ô∏è‚É£ Build Spring Boot JAR
      - name: Build Spring Boot
        shell: cmd
        run: gradlew.bat clean bootJar -x test

      - name: Check OpenSSH version
        shell: pwsh
        run: ssh -V

      - name: Write SSH key
        shell: pwsh
        run: |
          # Use runner's temp folder (safe for write)
          $keyPath = "C:\actions-runner\_work\_temp\android_key.pem"

          # Decode base64 key from secret
          $keyDecoded = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($env:ANDROID_KEY_BASE64))

          # Write key
          Set-Content -Path $keyPath -Value $keyDecoded -Encoding ascii -NoNewline

          Write-Host "‚úÖ SSH key written to $keyPath"

      # 4Ô∏è‚É£ Copy & Run JAR on Android using runner temp for SSH key
      - name: Copy & Run JAR on Android
        shell: pwsh
        run: |
          # --- Paths ---
          $keyPath = "$env:RUNNER_TEMP\android_key.pem"

          # --- Decode SSH key from secret ---
          if (-not $env:ANDROID_KEY_BASE64) { throw "ANDROID_KEY_BASE64 is not set" }
          $keyDecoded = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($env:ANDROID_KEY_BASE64))

          # --- Write SSH key to temp folder ---
          Set-Content -Path $keyPath -Value $keyDecoded -Encoding ascii -NoNewline
          Write-Host "‚úÖ SSH key written to $keyPath"

          # --- Find the JAR ---
          $jarPath = Get-ChildItem "$env:GITHUB_WORKSPACE\build\libs" -Filter "*.jar" | Select-Object -First 1
          if (-not $jarPath) { throw "No JAR found in build/libs" }

          # --- SCP JAR to Android ---
          $scpPath = "$env:SystemRoot\System32\OpenSSH\scp.exe"
          Write-Host "üöÄ Copying JAR to Android..."
          & $scpPath -v -i $keyPath -P $env:ANDROID_PORT "$($jarPath.FullName)" "$($env:ANDROID_USER)@$($env:ANDROID_HOST):/data/data/com.termux/files/home/app.jar"
          if ($LASTEXITCODE -ne 0) { throw "‚ùå SCP failed with exit code $LASTEXITCODE" }
          Write-Host "‚úÖ Copied successfully!"

          # --- Run Spring Boot JAR on Android ---
          $sshPath = "$env:SystemRoot\System32\OpenSSH\ssh.exe"
          Write-Host "üöÄ Starting app.jar on Android..."
          $sshArgs = @(
            "-i", $keyPath
            "-p", $env:ANDROID_PORT
            "$($env:ANDROID_USER)@$($env:ANDROID_HOST)"
            "pkill -f app.jar || true; nohup java -jar /data/data/com.termux/files/home/app.jar > app.log 2>&1 &"
          )
          & $sshPath @sshArgs
          if ($LASTEXITCODE -ne 0) { throw "‚ùå SSH command failed with exit code $LASTEXITCODE" }
          Write-Host "‚úÖ App started in background on Android"

        env:
          ANDROID_KEY_BASE64: ${{ secrets.ANDROID_KEY_BASE64 }}
          ANDROID_USER: ${{ secrets.ANDROID_USER }}
          ANDROID_HOST: ${{ secrets.ANDROID_HOST }}
          ANDROID_PORT: ${{ secrets.ANDROID_PORT }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
